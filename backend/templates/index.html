<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Atlas Chat Interface</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Audiowide&display=swap" rel="stylesheet">
    
    <!-- CSS Modules with cache busting -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v={{ range(1, 10000) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}?v={{ range(1, 10000) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}?v={{ range(1, 10000) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animations.css') }}?v={{ range(1, 10000) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/atlas_v2.css') }}?v={{ range(1, 10000) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat-page.css') }}?v={{ range(1, 10000) | random }}">
</head>
<body>
    <!-- Starry Background -->
    <div class="starry-background">
        <div class="stars" id="stars"></div>
    </div>

    <!-- Main App -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="toggle-btn" id="toggleBtn" aria-label="Toggle sidebar">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </button>

            <div class="logo-section">
                <div class="logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.5 3-9s-1.343-9-3-9m-9 9a9 9 0 019 9m-9-9a9 9 0 009-9m-9 9h12" />
                    </svg>
                </div>
                <span class="logo-text">Atlas</span>
            </div>

            <nav class="nav-section">
                <a href="/chat" class="nav-item active" data-mode="chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span class="nav-text">Chat</span>
                </a>
                <a href="/chat?mode=debate" class="nav-item" data-mode="debate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <span class="nav-text">Debate</span>
                </a>
                <div class="nav-item" id="historyBtn" role="button" tabindex="0">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="9"></circle>
                        <polyline points="12 7 12 12 16 14"></polyline>
                    </svg>
                    <span class="nav-text">History</span>
                </div>
                <div class="nav-item" id="settingsBtn" role="button" tabindex="0">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span class="nav-text">Settings</span>
                </div>
            </nav>

            <!-- Chat list hidden by default -->
            <div id="chatListContainer" style="padding:12px; border-top: 1px solid rgba(255,255,255,0.04); display:none;">
                <ul id="chatList" style="list-style:none; margin:0; padding:0; max-height:260px; overflow:auto;">
                    <!-- Chats will be populated here -->
                </ul>
            </div>

            <!-- Sidebar footer: New Chat button -->
            <div id="sidebarFooter" style="padding:12px; border-top: 1px solid rgba(255,255,255,0.04);">
                <button id="newChatBtn" class="input-btn" style="width:100%; padding:10px 12px; margin-top:8px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>+</span>
                    <span class="new-chat-text">New Chat</span>
                </button>
            </div>
        </aside>

        <!-- History Panel -->
        <div id="historyPanel" role="dialog" aria-hidden="true">
            <div class="history-header">
                <div class="history-title">Recent Chats</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="history-clear-btn" id="clearHistoryBtn" title="Clear all history" style="background: none; border: none; color: rgba(255,255,255,0.6); cursor: pointer; font-size: 12px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;">Clear All</button>
                    <button class="history-close" id="historyCloseBtn" aria-label="Close history">✕</button>
                </div>
            </div>
            <div style="flex:1; overflow:auto;">
                <ul id="historyList"></ul>
            </div>
        </div>

        <!-- Chat Container -->
        <main class="chat-container">
            <div class="mobile-header" style="display: none;">
                <button class="menu-btn" id="mobileMenuBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <span class="chat-title">Atlas Chat</span>
            </div>

            <header class="chat-header">
                <h1 class="chat-title" id="chatTitle">Chat with Atlas</h1>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="v2-toggle-label" style="color: rgba(255,255,255,0.7); font-size: 13px; font-weight: 600;">v2.0 Enhanced Analysis</span>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" id="v2Toggle" style="opacity: 0; width: 0; height: 0;">
                        <span class="v2-toggle-track" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: 0.3s; border-radius: 24px; border: 2px solid transparent;">
                            <span class="v2-toggle-slider" id="v2ToggleSlider" style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%;"></span>
                        </span>
                    </label>
                </div>
            </header>

            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here dynamically -->
            </div>

            <div class="input-container">
                <div id="attachmentArea" class="attachment-area"></div>
                <div class="input-toolbar">
                    <div class="toolbar-left">
                        <div class="attachment-container">
                            <button class="input-btn" id="attachBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14m-7-7h14" />
                                </svg>
                            </button>
                            <div class="attachment-menu" id="attachmentMenu">
                                <button class="menu-item" id="uploadFileBtn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                    <span>Upload File</span>
                                </button>
                                <button class="menu-item" id="addLinkBtn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/>
                                    </svg>
                                    <span>Add Link</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <span class="model-name send-text">SEND</span>
                        <button class="input-btn send-btn" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="input-wrapper">
                    <input type="text" class="message-input" id="messageInput" placeholder="Message Atlas..." />
                    <button class="input-btn mic-btn" id="micBtn" aria-label="Voice input">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Link Modal -->
    <div id="linkModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Add a Link</h2>
            <input type="text" id="linkInput" placeholder="https://example.com">
            <div class="modal-buttons">
                <button id="closeModalBtn">Cancel</button>
                <button id="submitLinkBtn">Add Link</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <h2 style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px;">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </h2>
            
            <!-- Theme Setting -->
            <div class="setting-item" style="padding: 12px 16px; margin-bottom: 8px;">
                <div class="setting-header" style="margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;">
                    <h3 class="setting-title" style="margin: 0; font-size: 15px; font-weight: 500;">Appearance</h3>
                    <div class="theme-dropdown" style="position: relative; min-width: 130px;">
                        <button class="dropdown-btn" id="themeDropdownBtn" style="width: 100%; padding: 6px 10px; background: #2d2d32; border: 1px solid #404040; border-radius: 5px; color: #e8e8e8; display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 13px;">
                            <span id="selectedTheme">Dark</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="dropdown-menu" id="themeDropdownMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: rgba(45,45,50,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 1000; overflow: hidden;">
                            <div class="dropdown-item" data-theme="system" style="padding: 10px 16px; cursor: pointer; color: #f8fafc; font-size: 14px; transition: background 0.2s;">
                                System
                            </div>
                            <div class="dropdown-item active" data-theme="dark" style="padding: 10px 16px; cursor: pointer; color: #f8fafc; font-size: 14px; transition: background 0.2s; background: rgba(255,255,255,0.08); position: relative;">
                                Dark
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; position: absolute; right: 12px; top: 50%; transform: translateY(-50%);">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <div class="dropdown-item" data-theme="light" style="padding: 10px 16px; cursor: pointer; color: #f8fafc; font-size: 14px; transition: background 0.2s;">
                                Light
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Language Setting -->
            <div class="setting-item" style="padding: 12px 16px; margin-bottom: 8px;">
                <div class="setting-header" style="margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;">
                    <h3 class="setting-title" style="margin: 0; font-size: 15px; font-weight: 500;">Language</h3>
                    <div class="language-dropdown" style="position: relative; min-width: 130px;">
                        <button class="dropdown-btn" id="languageDropdownBtn" style="width: 100%; padding: 6px 10px; background: #2d2d32; border: 1px solid #404040; border-radius: 5px; color: #e8e8e8; display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 13px;">
                            <span id="selectedLanguage">English</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="dropdown-menu" id="languageDropdownMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: rgba(45,45,50,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 1000; overflow: hidden;">
                            <div class="dropdown-item active" data-language="en" style="padding: 10px 16px; cursor: pointer; color: #f8fafc; font-size: 14px; transition: background 0.2s; background: rgba(255,255,255,0.08); position: relative;">
                                English
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; position: absolute; right: 12px; top: 50%; transform: translateY(-50%);">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <div class="dropdown-item" data-language="es" style="padding: 10px 16px; cursor: pointer; color: #f8fafc; font-size: 14px; transition: background 0.2s;">
                                Español
                            </div>
                            <div class="dropdown-item" data-language="fr" style="padding: 10px 16px; cursor: pointer; color: #f8fafc; font-size: 14px; transition: background 0.2s;">
                                Français
                            </div>
                            <div class="dropdown-item" data-language="de" style="padding: 10px 16px; cursor: pointer; color: #f8fafc; font-size: 14px; transition: background 0.2s;">
                                Deutsch
                            </div>
                            <div class="dropdown-item" data-language="zh" style="padding: 10px 16px; cursor: pointer; color: #f8fafc; font-size: 14px; transition: background 0.2s;">
                                中文
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="margin-top: 30px;">
                <button class="input-btn" id="closeSettingsBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="newChatModal" class="modal-overlay" style="display:none; opacity:0; align-items:center; justify-content:center;">
        <div class="modal-content" style="max-width:460px; width:92%; padding:18px;">
            <h2 style="margin-bottom:14px;">New Chat</h2>
            <input type="text" id="newChatTitle" class="message-input" placeholder="Chat title (optional)" style="width:100%; margin-bottom:12px;" />
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button id="cancelNewChatBtn" class="input-btn">Cancel</button>
                <button id="confirmNewChatBtn" class="input-btn primary">Create</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules -->
    <script src="{{ url_for('static', filename='js/settings.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/atlasv2.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/v2_ui.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/messages.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/chat_store.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/attachments.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/init.js') }}?v={{ range(1, 10000) | random }}"></script>
    <script src="{{ url_for('static', filename='js/atlas_v2.js') }}?v={{ range(1, 10000) | random }}"></script>
</body>
</html>
